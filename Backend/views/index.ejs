<!DOCTYPE html>
<html>

<head>
    <title>ESP32 Robot Control</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>

    <h2>Live Camera</h2>
    <img src="/stream" class="camera">

    <!-- <h2>Control</h2>

    <div class="controls">
        <button onclick="sendCmd('F')">⬆️ Forward</button>
        <div>
            <button onclick="sendCmd('L')">⬅️ Left</button>
            <button onclick="sendCmd('S')">⏹ Stop</button>
            <button onclick="sendCmd('R')">➡️ Right</button>
        </div>
        <button onclick="sendCmd('B')">⬇️ Backward</button>
    </div>

    <script>
        function sendCmd(cmd) {
            fetch("/control", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ command: cmd })
            });
        }
    </script> -->


    <h2>Joystick Control</h2>

    <div id="joystick">
        <div id="stick"></div>
    </div>

    <p id="status">x: 0 | y: 0</p>

    <script>
        const joystick = document.getElementById("joystick");
        const stick = document.getElementById("stick");
        const status = document.getElementById("status");

        let active = false;
        let centerX = 0, centerY = 0;
        let lastX = 0, lastY = 0;

        function send(x, y) {
            lastX = x;
            lastY = y;
            fetch("/control", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ x, y })
            });
        }

        function resetJoystick() {
            active = false;
            stick.style.transform = `translate(-50%, -50%)`;
            status.innerText = "x: 0 | y: 0";
            send(0, 0);
        }


        // ---------- TOUCH START ----------
        joystick.addEventListener("touchstart", e => {
            active = true;
            const r = joystick.getBoundingClientRect();
            centerX = r.left + r.width / 2;
            centerY = r.top + r.height / 2;
        });

        // ---------- TOUCH MOVE ----------
        joystick.addEventListener("touchmove", e => {
            if (!active) return;
            e.preventDefault();

            const t = e.touches[0];
            let dx = t.clientX - centerX;
            let dy = t.clientY - centerY;

            const max = 75;
            const dist = Math.min(Math.sqrt(dx * dx + dy * dy), max);
            const ang = Math.atan2(dy, dx);

            dx = Math.cos(ang) * dist;
            dy = Math.sin(ang) * dist;

            stick.style.transform = `translate(${dx - 55}px, ${dy - 55}px)`;

            const x = Math.round((dx / max) * 127);
            const y = Math.round((-dy / max) * 127);

            status.innerText = `x: ${x} | y: ${y}`;

            const now = Date.now();
            if (now - lastSend > 40) {
                send(x, y);
                lastSend = now;
            }
        });


        // ---------- ALL STOP EVENTS ----------
        ["touchend", "touchcancel"].forEach(evt => {
            joystick.addEventListener(evt, resetJoystick);
        });

        // If finger leaves joystick area
        document.addEventListener("touchend", resetJoystick);

        // If page loses focus (lock screen, tab change)
        window.addEventListener("blur", resetJoystick);
    </script>


</body>

</html>